name: CI Feedback Tracking

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    
permissions:
  contents: write
  issues: write

jobs:
  track-failures:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate feedback report
        id: feedback
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RUN_URL="${{ github.event.workflow_run.html_url }}"
          RUN_ID="${{ github.event.workflow_run.id }}"
          
          # Create feedback directory if not exists
          mkdir -p docs/ci-feedback
          
          # Generate report filename
          REPORT_FILE="docs/ci-feedback/${TIMESTAMP}-ci-failure-${RUN_ID}.md"
          
          # Create basic report
          cat > "$REPORT_FILE" << EOF
          # CI Feedback Report: Automated CI Failure Detection
          
          ## 📅 発生日時
          $(date '+%Y-%m-%d %H:%M:%S %Z')
          
          ## 🔍 検知方法
          - [x] CI自動検知
          - [ ] 手動確認
          - [ ] ユーザー報告
          
          ## ❌ エラー概要
          - **Workflow**: ${{ github.event.workflow_run.name }}
          - **Run ID**: ${RUN_ID}
          - **Branch**: ${{ github.event.workflow_run.head_branch }}
          - **Commit**: ${{ github.event.workflow_run.head_sha }}
          - **CI Run URL**: ${RUN_URL}
          
          ## 🎯 影響範囲
          - **Severity**: TBD (要分析)
          - **Affected Environments**: GitHub Actions
          - **Affected Users**: TBD
          - **Business Impact**: CI Pipeline Blocked
          
          ## 🔬 根本原因分析
          ### 自動収集情報
          - Workflow: ${{ github.event.workflow_run.name }}
          - Event: ${{ github.event.workflow_run.event }}
          - Status: ${{ github.event.workflow_run.status }}
          - Conclusion: ${{ github.event.workflow_run.conclusion }}
          
          ### 詳細分析
          **要手動確認**: [View Logs](${RUN_URL})
          
          ## ✅ 改善内容
          ### 対応状況
          - [ ] ログ分析
          - [ ] 根本原因特定
          - [ ] 修正実装
          - [ ] テスト確認
          - [ ] リリース
          
          ## 📝 備考
          This report was automatically generated by CI Feedback Tracking workflow.
          Manual review and analysis required.
          
          ---
          **Status**: 🔴 未対応
          EOF
          
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Create tracking issue
        if: ${{ github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master' }}
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = '${{ github.event.workflow_run.html_url }}';
            const timestamp = '${{ steps.feedback.outputs.timestamp }}';
            
            // Create issue for main branch failures
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI Failure: ${timestamp}`,
              body: `## CI Failure Detected\n\n- **Run URL**: ${runUrl}\n- **Branch**: ${{ github.event.workflow_run.head_branch }}\n- **Commit**: ${{ github.event.workflow_run.head_sha }}\n\n### Action Required\n- [ ] Analyze failure logs\n- [ ] Update feedback report\n- [ ] Implement fix if needed\n\n[View automated report](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/${{ steps.feedback.outputs.report_file }})`,
              labels: ['ci', 'automated']
            });
            
            console.log(`Issue created: ${issue.data.number}`);

      - name: Commit feedback report
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add docs/ci-feedback/
          git commit -m "ci: automated feedback report for run ${{ github.event.workflow_run.id }}
          
          🔴 CI Failure detected and logged
          - Timestamp: ${{ steps.feedback.outputs.timestamp }}
          - Run: ${{ github.event.workflow_run.html_url }}
          
          This is an automated feedback tracking commit." || echo "No changes to commit"
          
          git push || echo "No changes to push"

  track-success:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Log success metrics
        run: |
          echo "✅ CI Run successful"
          echo "Run ID: ${{ github.event.workflow_run.id }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          # Success metrics can be aggregated for weekly/monthly reports